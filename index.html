<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ“ğŸ…â™¨ï¸</title>
    <style>
      /* é‡ç½®æ ·å¼ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f5f5f5;
        color: #333;
        height: 100vh;
        overflow: hidden;
      }

      /* ä¸»å®¹å™¨ */
      .container {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 20px;
        gap: 20px;
      }

      /* æ ‡é¢˜ */
      .title {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 10px;
      }

      /* å†…å®¹åŒºåŸŸ */
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* æ€»å­¦ä¹ æ—¶é•¿ */
      .study-time {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .study-time-display {
        font-size: 3rem;
        font-weight: bold;
        color: #4caf50;
      }

      /* ç•ªèŒ„é’Ÿå’Œç©ºé—²é’Ÿå®¹å™¨ */
      .timer-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* ç•ªèŒ„é’Ÿ */
      .pomodoro {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        flex: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* ç©ºé—²é’Ÿ */
      .idle {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* åœ†å½¢è¿›åº¦æ¡å®¹å™¨ */
      .circular-progress {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 20px 0;
      }

      .circular-progress svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
      }

      .circular-progress .background {
        fill: none;
        stroke: #e0e0e0;
        stroke-width: 10;
      }

      .circular-progress .progress {
        fill: none;
        stroke: #ff5722;
        stroke-width: 10;
        stroke-linecap: round;
        stroke-dasharray: 565.48;
        stroke-dashoffset: 565.48;
        transition: stroke-dashoffset 1s linear;
      }

      .circular-progress .time-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: bold;
      }

      /* æ¡å½¢è¿›åº¦æ¡ */
      .linear-progress {
        width: 100%;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        margin: 20px 0;
        overflow: hidden;
      }

      .linear-progress .progress {
        height: 100%;
        background-color: #2196f3;
        width: 0%;
        transition: width 1s linear;
      }

      /* æ—¶é—´è¾“å…¥ */
      .time-input {
        font-size: 1.5rem;
        border: none;
        background: transparent;
        text-align: center;
        width: 100px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .time-input:focus {
        outline: none;
        background-color: #f0f0f0;
        border-radius: 4px;
        transform: scale(1.05);
      }

      .time-input:disabled {
        cursor: not-allowed;
        opacity: 0.7;
      }

      /* æ§åˆ¶æŒ‰é’® */
      .controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background-color: #f0f0f0;
        transform: scale(1.1);
      }

      .btn:active {
        transform: scale(0.95);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* å“åº”å¼å¸ƒå±€ */
      @media (min-width: 768px) {
        .content {
          flex-direction: row;
          transition: flex-direction 0.3s ease;
        }

        .study-time {
          flex: 1;
          transition: flex 0.3s ease;
        }

        .timer-container {
          flex: 2;
          flex-direction: row;
          transition: flex 0.3s ease, flex-direction 0.3s ease;
        }
      }

      @media (min-width: 1200px) {
        .container {
          display: grid;
          grid-template-columns: 2fr 1fr;
          grid-template-rows: auto 1fr 1fr;
          gap: 20px;
          transition: all 0.3s ease;
        }

        .title {
          grid-column: 1 / -1;
        }

        .pomodoro {
          grid-row: 2 / 4;
          grid-column: 1;
          transition: all 0.3s ease;
        }

        .study-time {
          grid-row: 2;
          grid-column: 2;
          transition: all 0.3s ease;
        }

        .idle {
          grid-row: 3;
          grid-column: 2;
          transition: all 0.3s ease;
        }

        .content {
          display: contents;
        }

        .timer-container {
          display: contents;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">ğŸ“ğŸ…â™¨ï¸</h1>

      <div class="content">
        <div class="study-time">
          <h2>ğŸ“</h2>
          <div class="study-time-display">0:00</div>
        </div>

        <div class="timer-container">
          <div class="pomodoro">
            <h2>ğŸ…</h2>
            <div class="circular-progress">
              <svg>
                <circle class="background" cx="100" cy="100" r="90"></circle>
                <circle class="progress" cx="100" cy="100" r="90"></circle>
              </svg>
              <div class="time-display">
                <input type="text" class="time-input" value="25:00" readonly />
              </div>
            </div>
            <div class="controls">
              <button class="btn start-btn">â–¶ï¸</button>
              <button class="btn pause-btn" style="display: none">â¸ï¸</button>
              <button class="btn stop-btn" style="display: none">â¹ï¸</button>
            </div>
          </div>

          <div class="idle">
            <h2>â™¨ï¸</h2>
            <div class="linear-progress">
              <div class="progress"></div>
            </div>
            <div class="time-display">
              <input type="text" class="time-input" value="5:00" readonly />
            </div>
            <div class="controls">
              <button class="btn start-btn">â–¶ï¸</button>
              <button class="btn pause-btn" style="display: none">â¸ï¸</button>
              <button class="btn stop-btn" style="display: none">â¹ï¸</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // æ•°æ®ç®¡ç†
      const dataManager = {
        // åˆå§‹åŒ–æ•°æ®
        init() {
          const data = localStorage.getItem("timerData");
          if (data) {
            return JSON.parse(data);
          } else {
            return {
              totalStudyTime: 0,
              pomodoroTime: 1500, // 25 åˆ†é’Ÿ
              idleTime: 300, // 5 åˆ†é’Ÿ
            };
          }
        },

        // ä¿å­˜æ•°æ®
        save(data) {
          localStorage.setItem("timerData", JSON.stringify(data));
        },

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬ HH:MMï¼‰
        formatTime(seconds) {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          return `${hours}:${minutes.toString().padStart(2, "0")}`;
        },

        // æ ¼å¼åŒ–å€’è®¡æ—¶ï¼ˆç§’è½¬ MM:SSï¼‰
        formatCountdown(seconds) {
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${minutes}:${secs.toString().padStart(2, "0")}`;
        },
      };

      // ç•ªèŒ„é’Ÿæ§åˆ¶å™¨
      class PomodoroTimer {
        constructor(element) {
          this.element = element;
          this.timeInput = element.querySelector(".time-input");
          this.startBtn = element.querySelector(".start-btn");
          this.pauseBtn = element.querySelector(".pause-btn");
          this.stopBtn = element.querySelector(".stop-btn");
          this.progressCircle = element.querySelector(
            ".circular-progress .progress"
          );
          this.circumference = 2 * Math.PI * 90; // åœ†çš„å‘¨é•¿

          this.data = dataManager.init();
          this.totalTime = this.data.pomodoroTime;
          this.remainingTime = this.totalTime;
          this.isRunning = false;
          this.interval = null;

          this.init();
        }

        init() {
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.updateProgress();

          // äº‹ä»¶ç›‘å¬
          this.startBtn.addEventListener("click", () => this.start());
          this.pauseBtn.addEventListener("click", () => this.pause());
          this.stopBtn.addEventListener("click", () => this.stop());

          // å…è®¸ç¼–è¾‘æ—¶é—´
          this.timeInput.addEventListener("blur", () => {
            if (!this.isRunning) {
              const timeParts = this.timeInput.value.split(":");
              if (timeParts.length === 2) {
                const minutes = parseInt(timeParts[0], 10);
                const seconds = parseInt(timeParts[1], 10);

                // éªŒè¯è¾“å…¥
                if (
                  !isNaN(minutes) &&
                  !isNaN(seconds) &&
                  minutes >= 0 &&
                  minutes <= 99 &&
                  seconds >= 0 &&
                  seconds <= 59
                ) {
                  this.totalTime = minutes * 60 + seconds;
                  this.remainingTime = this.totalTime;
                  this.data.pomodoroTime = this.totalTime;
                  dataManager.save(this.data);
                  this.updateProgress();
                }
              }
              // é‡ç½®ä¸ºæœ‰æ•ˆæ ¼å¼
              this.timeInput.value = dataManager.formatCountdown(
                this.remainingTime
              );
            }
          });

          // é™åˆ¶è¾“å…¥æ ¼å¼
          this.timeInput.addEventListener("input", (e) => {
            let value = e.target.value;
            // åªå…è®¸æ•°å­—å’Œå†’å·
            value = value.replace(/[^0-9:]/g, "");

            // è‡ªåŠ¨æ ¼å¼åŒ–
            if (value.length > 2 && value.indexOf(":") === -1) {
              value = value.slice(0, 2) + ":" + value.slice(2);
            }

            // é™åˆ¶é•¿åº¦
            if (value.length > 5) {
              value = value.slice(0, 5);
            }

            e.target.value = value;
          });
        }

        start() {
          if (!this.isRunning) {
            this.isRunning = true;
            this.timeInput.readOnly = true;
            this.startBtn.style.display = "none";
            this.pauseBtn.style.display = "inline-block";
            this.stopBtn.style.display = "inline-block";

            this.interval = setInterval(() => {
              this.remainingTime--;
              this.timeInput.value = dataManager.formatCountdown(
                this.remainingTime
              );
              this.updateProgress();

              if (this.remainingTime <= 0) {
                this.complete();
              }
            }, 1000);
          }
        }

        pause() {
          if (this.isRunning) {
            this.isRunning = false;
            clearInterval(this.interval);
            this.startBtn.style.display = "inline-block";
            this.pauseBtn.style.display = "none";
          }
        }

        stop() {
          this.isRunning = false;
          clearInterval(this.interval);

          // å°†å·²è¿›è¡Œçš„æ—¶é—´åŠ å…¥æ€»å­¦ä¹ æ—¶é•¿
          const elapsed = this.totalTime - this.remainingTime;
          this.data.totalStudyTime += elapsed;
          dataManager.save(this.data);
          studyTimeDisplay.textContent = dataManager.formatTime(
            this.data.totalStudyTime
          );

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";
        }

        complete() {
          this.isRunning = false;
          clearInterval(this.interval);

          // å°†å…¨éƒ¨æ—¶é—´åŠ å…¥æ€»å­¦ä¹ æ—¶é•¿
          this.data.totalStudyTime += this.totalTime;
          dataManager.save(this.data);
          studyTimeDisplay.textContent = dataManager.formatTime(
            this.data.totalStudyTime
          );

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";

          // å‘é€é€šçŸ¥
          this.sendNotification("ç•ªèŒ„é’Ÿå®Œæˆ", "æ­å–œä½ å®Œæˆäº†ä¸€ä¸ªç•ªèŒ„é’Ÿï¼");
        }

        updateProgress() {
          const progress =
            (this.totalTime - this.remainingTime) / this.totalTime;
          const offset = this.circumference - progress * this.circumference;
          this.progressCircle.style.strokeDashoffset = offset;
        }

        sendNotification(title, message) {
          if ("Notification" in window) {
            if (Notification.permission === "granted") {
              new Notification(title, { body: message });
            } else if (Notification.permission !== "denied") {
              Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                  new Notification(title, { body: message });
                }
              });
            }
          }

          // æ’­æ”¾å£°éŸ³
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT"
          );
          audio.play();
        }
      }

      // ç©ºé—²é’Ÿæ§åˆ¶å™¨
      class IdleTimer {
        constructor(element) {
          this.element = element;
          this.timeInput = element.querySelector(".time-input");
          this.startBtn = element.querySelector(".start-btn");
          this.pauseBtn = element.querySelector(".pause-btn");
          this.stopBtn = element.querySelector(".stop-btn");
          this.progressBar = element.querySelector(
            ".linear-progress .progress"
          );

          this.data = dataManager.init();
          this.totalTime = this.data.idleTime;
          this.remainingTime = this.totalTime;
          this.isRunning = false;
          this.interval = null;

          this.init();
        }

        init() {
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.updateProgress();

          // äº‹ä»¶ç›‘å¬
          this.startBtn.addEventListener("click", () => this.start());
          this.pauseBtn.addEventListener("click", () => this.pause());
          this.stopBtn.addEventListener("click", () => this.stop());

          // å…è®¸ç¼–è¾‘æ—¶é—´
          this.timeInput.addEventListener("blur", () => {
            if (!this.isRunning) {
              const timeParts = this.timeInput.value.split(":");
              if (timeParts.length === 2) {
                const minutes = parseInt(timeParts[0], 10);
                const seconds = parseInt(timeParts[1], 10);

                // éªŒè¯è¾“å…¥
                if (
                  !isNaN(minutes) &&
                  !isNaN(seconds) &&
                  minutes >= 0 &&
                  minutes <= 99 &&
                  seconds >= 0 &&
                  seconds <= 59
                ) {
                  this.totalTime = minutes * 60 + seconds;
                  this.remainingTime = this.totalTime;
                  this.data.idleTime = this.totalTime;
                  dataManager.save(this.data);
                  this.updateProgress();
                }
              }
              // é‡ç½®ä¸ºæœ‰æ•ˆæ ¼å¼
              this.timeInput.value = dataManager.formatCountdown(
                this.remainingTime
              );
            }
          });

          // é™åˆ¶è¾“å…¥æ ¼å¼
          this.timeInput.addEventListener("input", (e) => {
            let value = e.target.value;
            // åªå…è®¸æ•°å­—å’Œå†’å·
            value = value.replace(/[^0-9:]/g, "");

            // è‡ªåŠ¨æ ¼å¼åŒ–
            if (value.length > 2 && value.indexOf(":") === -1) {
              value = value.slice(0, 2) + ":" + value.slice(2);
            }

            // é™åˆ¶é•¿åº¦
            if (value.length > 5) {
              value = value.slice(0, 5);
            }

            e.target.value = value;
          });
        }

        start() {
          if (!this.isRunning) {
            this.isRunning = true;
            this.timeInput.readOnly = true;
            this.startBtn.style.display = "none";
            this.pauseBtn.style.display = "inline-block";
            this.stopBtn.style.display = "inline-block";

            this.interval = setInterval(() => {
              this.remainingTime--;
              this.timeInput.value = dataManager.formatCountdown(
                this.remainingTime
              );
              this.updateProgress();

              if (this.remainingTime <= 0) {
                this.complete();
              }
            }, 1000);
          }
        }

        pause() {
          if (this.isRunning) {
            this.isRunning = false;
            clearInterval(this.interval);
            this.startBtn.style.display = "inline-block";
            this.pauseBtn.style.display = "none";
          }
        }

        stop() {
          this.isRunning = false;
          clearInterval(this.interval);

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";
        }

        complete() {
          this.isRunning = false;
          clearInterval(this.interval);

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";

          // å‘é€é€šçŸ¥
          this.sendNotification("ç©ºé—²æ—¶é—´ç»“æŸ", "ä¼‘æ¯æ—¶é—´ç»“æŸäº†ï¼");
        }

        updateProgress() {
          const progress =
            (this.totalTime - this.remainingTime) / this.totalTime;
          this.progressBar.style.width = `${progress * 100}%`;
        }

        sendNotification(title, message) {
          if ("Notification" in window) {
            if (Notification.permission === "granted") {
              new Notification(title, { body: message });
            } else if (Notification.permission !== "denied") {
              Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                  new Notification(title, { body: message });
                }
              });
            }
          }

          // æ’­æ”¾å£°éŸ³
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT"
          );
          audio.play();
        }
      }

      // åˆå§‹åŒ–åº”ç”¨
      const data = dataManager.init();
      const studyTimeDisplay = document.querySelector(".study-time-display");
      studyTimeDisplay.textContent = dataManager.formatTime(
        data.totalStudyTime
      );

      // åˆå§‹åŒ–ç•ªèŒ„é’Ÿ
      const pomodoroElement = document.querySelector(".pomodoro");
      const pomodoroTimer = new PomodoroTimer(pomodoroElement);

      // åˆå§‹åŒ–ç©ºé—²é’Ÿ
      const idleElement = document.querySelector(".idle");
      const idleTimer = new IdleTimer(idleElement);

      // è¯·æ±‚é€šçŸ¥æƒé™
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }

      // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
      let lastVisibleTime = Date.now();

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œè®¡ç®—ç»è¿‡çš„æ—¶é—´å¹¶æ›´æ–°è®¡æ—¶å™¨
          const now = Date.now();
          const elapsedSeconds = Math.floor((now - lastVisibleTime) / 1000);

          if (pomodoroTimer.isRunning) {
            pomodoroTimer.remainingTime = Math.max(
              0,
              pomodoroTimer.remainingTime - elapsedSeconds
            );
            pomodoroTimer.timeInput.value = dataManager.formatCountdown(
              pomodoroTimer.remainingTime
            );
            pomodoroTimer.updateProgress();

            if (pomodoroTimer.remainingTime <= 0) {
              pomodoroTimer.complete();
            }
          }

          if (idleTimer.isRunning) {
            idleTimer.remainingTime = Math.max(
              0,
              idleTimer.remainingTime - elapsedSeconds
            );
            idleTimer.timeInput.value = dataManager.formatCountdown(
              idleTimer.remainingTime
            );
            idleTimer.updateProgress();

            if (idleTimer.remainingTime <= 0) {
              idleTimer.complete();
            }
          }
        }

        lastVisibleTime = Date.now();
      });

      // é¡µé¢å…³é—­å‰æé†’
      window.addEventListener("beforeunload", (e) => {
        if (pomodoroTimer.isRunning || idleTimer.isRunning) {
          e.preventDefault();
          e.returnValue = "æ‚¨æœ‰æ­£åœ¨è¿è¡Œçš„è®¡æ—¶å™¨ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ";
          return e.returnValue;
        }
      });
    </script>
  </body>
</html>
