<!DOCTYPE html>
<html lang="zh-Hans-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="ğŸ“ğŸ…â™¨ï¸ - é«˜æ•ˆè®°å½•è¿›åº¦çš„ç•ªèŒ„é’Ÿ" />
    <meta name="keywords" content="è¿›åº¦è·Ÿè¸ª,æ•ˆç‡å·¥å…·,æ—¶é—´ç®¡ç†" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EâŒš%3C/text%3E%3C/svg%3E"
    />
    <title>ğŸ“ğŸ…â™¨ï¸</title>
    <style>
      /* CSS å˜é‡å®šä¹‰ - æµ…è‰²ä¸»é¢˜ */
      :root {
        /* èƒŒæ™¯è‰² */
        --bg-primary: #f5f5f5;
        --bg-secondary: #fff;
        --bg-tertiary: #f0f0f0;

        /* æ–‡å­—é¢œè‰² */
        --text-primary: #333;
        --text-secondary: #4caf50;
        --text-accent-1: #ff5722;
        --text-accent-2: #2196f3;

        /* è¾¹æ¡†å’Œè¿›åº¦æ¡ */
        --border-primary: #e0e0e0;

        /* é˜´å½± */
        --shadow-primary: rgba(0, 0, 0, 0.1);

        /* é€æ˜åº¦ */
        --opacity-disabled: 0.7;
        --opacity-button-disabled: 0.5;

        /* è¿‡æ¸¡æ•ˆæœ */
        --transition-base: all 0.3s ease;
        --transition-progress: width 1s linear, stroke-dashoffset 1s linear;
      }

      /* æ·±è‰²ä¸»é¢˜å˜é‡ */
      @media (prefers-color-scheme: dark) {
        :root {
          /* èƒŒæ™¯è‰² */
          --bg-primary: #1a1a1a;
          --bg-secondary: #2d2d2d;
          --bg-tertiary: #3a3a3a;

          /* æ–‡å­—é¢œè‰² */
          --text-primary: #e0e0e0;
          --text-secondary: #66bb6a;
          --text-accent-1: #ff7043;
          --text-accent-2: #42a5f5;

          /* è¾¹æ¡†å’Œè¿›åº¦æ¡ */
          --border-primary: #4a4a4a;

          /* é˜´å½± */
          --shadow-primary: rgba(0, 0, 0, 0.3);
        }
      }

      /* é‡ç½®æ ·å¼ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        transition: var(--transition-base);
      }

      /* ä¸»å®¹å™¨ */
      .container {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 20px;
        gap: 20px;
        overflow: scroll;
      }

      /* æ ‡é¢˜ */
      .title {
        display: none;
        text-align: center;
        font-size: 2rem;
        margin-bottom: 10px;
      }

      /* å†…å®¹åŒºåŸŸ */
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* æ€»å­¦ä¹ æ—¶é•¿ */
      .study-time {
        background-color: var(--bg-secondary);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px var(--shadow-primary);
        transition: var(--transition-base);
      }

      .study-time-display {
        font-size: 3rem;
        font-weight: bold;
        color: var(--text-secondary);
        transition: var(--transition-base);
      }

      /* ç•ªèŒ„é’Ÿå’Œç©ºé—²é’Ÿå®¹å™¨ */
      .timer-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* ç•ªèŒ„é’Ÿ */
      .pomodoro {
        background-color: var(--bg-secondary);
        border-radius: 8px;
        padding: 20px;
        flex: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px var(--shadow-primary);
        transition: var(--transition-base);
      }

      /* ç©ºé—²é’Ÿ */
      .idle {
        background-color: var(--bg-secondary);
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px var(--shadow-primary);
        transition: var(--transition-base);
      }

      /* åœ†å½¢è¿›åº¦æ¡å®¹å™¨ */
      .circular-progress {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 20px 0;
      }

      .circular-progress svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
      }

      .circular-progress .background {
        fill: none;
        stroke: var(--border-primary);
        stroke-width: 10;
        transition: var(--transition-base);
      }

      .circular-progress .progress {
        fill: none;
        stroke: var(--text-accent-1);
        stroke-width: 10;
        stroke-linecap: round;
        stroke-dasharray: 565.48;
        stroke-dashoffset: 565.48;
        transition: var(--transition-progress);
      }

      .circular-progress .time-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: bold;
        color: inherit;
        transition: var(--transition-base);
      }

      .idle .time-display {
        font-size: 1.5rem;
        font-weight: bold;
        color: inherit;
        transition: var(--transition-base);
      }

      /* æ¡å½¢è¿›åº¦æ¡ */
      .linear-progress {
        width: 100%;
        height: 20px;
        background-color: var(--border-primary);
        border-radius: 10px;
        margin: 20px 0;
        overflow: hidden;
        transition: var(--transition-base);
      }

      .linear-progress .progress {
        height: 100%;
        background-color: var(--text-accent-2);
        width: 0%;
        transition: var(--transition-progress);
      }

      /* æ—¶é—´è¾“å…¥ */
      .time-input {
        font-size: 1.5rem;
        border: none;
        background: transparent;
        text-align: center;
        width: 120px;
        font-weight: bold;
        transition: var(--transition-base);
        color: inherit;
      }

      .time-input:focus {
        outline: none;
        background-color: var(--bg-tertiary);
        border-radius: 4px;
        transform: scale(1.05);
      }

      .time-input:disabled {
        cursor: not-allowed;
        opacity: var(--opacity-disabled);
      }

      /* æ§åˆ¶æŒ‰é’® */
      .controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: var(--transition-base);
        color: inherit;
      }

      .btn:hover {
        background-color: var(--bg-tertiary);
        transform: scale(1.1);
      }

      .btn:active {
        transform: scale(0.95);
      }

      .btn:disabled {
        opacity: var(--opacity-button-disabled);
        cursor: not-allowed;
        transform: none;
      }

      /* å“åº”å¼å¸ƒå±€ */
      @media (min-width: 768px) {
        .content {
          flex-direction: row;
          transition: flex-direction 0.3s ease;
        }

        .study-time {
          flex: 1;
          transition: flex 0.3s ease;
        }

        .timer-container {
          flex: 2;
          flex-direction: row;
          transition: flex 0.3s ease, flex-direction 0.3s ease;
        }
      }

      @media (min-width: 1200px) {
        .container {
          display: grid;
          grid-template-columns: 2fr 1fr;
          grid-template-rows: auto 1fr 1fr;
          gap: 20px;
          transition: var(--transition-base);
        }

        .title {
          grid-column: 1 / -1;
        }

        .pomodoro {
          grid-row: 2 / 4;
          grid-column: 1;
          transition: var(--transition-base);
        }

        .study-time {
          grid-row: 2;
          grid-column: 2;
          transition: var(--transition-base);
        }

        .idle {
          grid-row: 3;
          grid-column: 2;
          transition: var(--transition-base);
        }

        .content {
          display: contents;
        }

        .timer-container {
          display: contents;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">ğŸ“ğŸ…â™¨ï¸</h1>

      <div class="content">
        <div class="study-time">
          <h2>ğŸ“</h2>
          <div class="study-time-display">0:00</div>
        </div>

        <div class="timer-container">
          <div class="pomodoro">
            <h2>ğŸ…</h2>
            <div class="circular-progress">
              <svg>
                <circle class="background" cx="100" cy="100" r="90"></circle>
                <circle class="progress" cx="100" cy="100" r="90"></circle>
              </svg>
              <div class="time-display">
                <input type="text" class="time-input" value="25:00" />
              </div>
            </div>
            <div class="controls">
              <button class="btn start-btn">â–¶ï¸</button>
              <button class="btn pause-btn" style="display: none">â¸ï¸</button>
              <button class="btn stop-btn" style="display: none">â¹ï¸</button>
            </div>
          </div>

          <div class="idle">
            <h2>â™¨ï¸</h2>
            <div class="linear-progress">
              <div class="progress"></div>
            </div>
            <div class="time-display">
              <input type="text" class="time-input" value="5:00" />
            </div>
            <div class="controls">
              <button class="btn start-btn">â–¶ï¸</button>
              <button class="btn pause-btn" style="display: none">â¸ï¸</button>
              <button class="btn stop-btn" style="display: none">â¹ï¸</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // æ•°æ®ç®¡ç†
      const dataManager = {
        // åˆå§‹åŒ–æ•°æ®
        init() {
          const data = localStorage.getItem("timerData");
          if (data) {
            return JSON.parse(data);
          } else {
            return {
              totalStudyTime: 0,
              pomodoroTime: 1500, // 25 åˆ†é’Ÿ
              idleTime: 300, // 5 åˆ†é’Ÿ
            };
          }
        },

        // ä¿å­˜æ•°æ®
        save(data) {
          localStorage.setItem("timerData", JSON.stringify(data));
        },

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬ HH:MMï¼‰
        formatTime(seconds) {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          return `${hours}:${minutes.toString().padStart(2, "0")}`;
        },

        // æ ¼å¼åŒ–å€’è®¡æ—¶ï¼ˆç§’è½¬ MM:SSï¼‰
        formatCountdown(seconds) {
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${minutes}:${secs.toString().padStart(2, "0")}`;
        },
      };

      // ç•ªèŒ„é’Ÿæ§åˆ¶å™¨
      class PomodoroTimer {
        constructor(element) {
          this.element = element;
          this.timeInput = element.querySelector(".time-input");
          this.startBtn = element.querySelector(".start-btn");
          this.pauseBtn = element.querySelector(".pause-btn");
          this.stopBtn = element.querySelector(".stop-btn");
          this.progressCircle = element.querySelector(
            ".circular-progress .progress"
          );
          this.circumference = 2 * Math.PI * 90; // åœ†çš„å‘¨é•¿

          this.data = dataManager.init();
          this.totalTime = this.data.pomodoroTime;
          this.remainingTime = this.totalTime;
          this.isRunning = false;
          this.interval = null;

          this.init();
        }

        init() {
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.updateProgress();

          // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸‹è¾“å…¥æ¡†å¯ç¼–è¾‘
          this.timeInput.readOnly = false;

          // äº‹ä»¶ç›‘å¬
          this.startBtn.addEventListener("click", () => this.start());
          this.pauseBtn.addEventListener("click", () => this.pause());
          this.stopBtn.addEventListener("click", () => this.stop());

          // å…è®¸ç¼–è¾‘æ—¶é—´
          this.timeInput.addEventListener("blur", () => {
            if (!this.isRunning) {
              const timeParts = this.timeInput.value.split(":");
              if (timeParts.length === 2) {
                const minutes = parseInt(timeParts[0], 10);
                const seconds = parseInt(timeParts[1], 10);

                // éªŒè¯è¾“å…¥
                if (
                  !isNaN(minutes) &&
                  !isNaN(seconds) &&
                  minutes >= 0 &&
                  minutes <= 1440 &&
                  seconds >= 0 &&
                  seconds <= 59
                ) {
                  this.totalTime = minutes * 60 + seconds;
                  this.remainingTime = this.totalTime;
                  this.data.pomodoroTime = this.totalTime;
                  dataManager.save(this.data);
                  this.updateProgress();
                } else {
                  // è¾“å…¥æ— æ•ˆï¼Œé‡ç½®ä¸ºä¹‹å‰çš„æœ‰æ•ˆå€¼
                  this.timeInput.value = dataManager.formatCountdown(
                    this.remainingTime
                  );
                }
              } else {
                // æ ¼å¼æ— æ•ˆï¼Œé‡ç½®ä¸ºä¹‹å‰çš„æœ‰æ•ˆå€¼
                this.timeInput.value = dataManager.formatCountdown(
                  this.remainingTime
                );
              }
            }
          });

          // é™åˆ¶è¾“å…¥æ ¼å¼
          this.timeInput.addEventListener("input", (e) => {
            let value = e.target.value;
            // åªå…è®¸æ•°å­—å’Œå†’å·
            value = value.replace(/[^0-9:]/g, "");

            // å¤„ç†å†’å·ä½ç½®
            const colonIndex = value.indexOf(":");

            if (colonIndex === -1) {
              // æ²¡æœ‰å†’å·ï¼Œè‡ªåŠ¨åœ¨å€’æ•°ç¬¬äºŒä½å‰æ·»åŠ å†’å·
              if (value.length >= 3) {
                value = value.slice(0, -2) + ":" + value.slice(-2);
              }
            } else {
              // æœ‰å†’å·ï¼Œç¡®ä¿å†’å·ååªæœ‰ä¸¤ä½æ•°å­—
              const parts = value.split(":");
              if (parts.length === 2) {
                const minutes = parts[0];
                let seconds = parts[1];

                // é™åˆ¶ç§’æ•°ä¸ºä¸¤ä½
                if (seconds.length > 2) {
                  seconds = seconds.slice(0, 2);
                }

                value = minutes + ":" + seconds;
              }
            }

            // é™åˆ¶æ€»é•¿åº¦ï¼ˆåˆ†é’Ÿæœ€å¤š4ä½ + å†’å· + ç§’æ•°2ä½ = 7ä½ï¼‰
            if (value.length > 7) {
              value = value.slice(0, 7);
            }

            e.target.value = value;
          });
        }

        start() {
          if (!this.isRunning) {
            this.isRunning = true;
            this.timeInput.readOnly = true;
            this.startBtn.style.display = "none";
            this.pauseBtn.style.display = "inline-block";
            this.stopBtn.style.display = "inline-block";

            this.interval = setInterval(() => {
              this.remainingTime--;
              this.timeInput.value = dataManager.formatCountdown(
                this.remainingTime
              );
              this.updateProgress();

              if (this.remainingTime <= 0) {
                this.complete();
              }
            }, 1000);
          }
        }

        pause() {
          if (this.isRunning) {
            this.isRunning = false;
            clearInterval(this.interval);
            this.startBtn.style.display = "inline-block";
            this.pauseBtn.style.display = "none";
          }
        }

        stop() {
          this.isRunning = false;
          clearInterval(this.interval);

          // å°†å·²è¿›è¡Œçš„æ—¶é—´åŠ å…¥æ€»å­¦ä¹ æ—¶é•¿
          const elapsed = this.totalTime - this.remainingTime;
          this.data.totalStudyTime += elapsed;
          dataManager.save(this.data);
          studyTimeDisplay.textContent = dataManager.formatTime(
            this.data.totalStudyTime
          );

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";
        }

        complete() {
          this.isRunning = false;
          clearInterval(this.interval);

          // å°†å…¨éƒ¨æ—¶é—´åŠ å…¥æ€»å­¦ä¹ æ—¶é•¿
          this.data.totalStudyTime += this.totalTime;
          dataManager.save(this.data);
          studyTimeDisplay.textContent = dataManager.formatTime(
            this.data.totalStudyTime
          );

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";

          // å‘é€é€šçŸ¥
          this.sendNotification("ç•ªèŒ„é’Ÿå®Œæˆ", "æ­å–œä½ å®Œæˆäº†ä¸€ä¸ªç•ªèŒ„é’Ÿï¼");
        }

        updateProgress() {
          const progress =
            (this.totalTime - this.remainingTime) / this.totalTime;
          const offset = this.circumference - progress * this.circumference;
          this.progressCircle.style.strokeDashoffset = offset;
        }

        sendNotification(title, message) {
          if ("Notification" in window) {
            if (Notification.permission === "granted") {
              new Notification(title, { body: message });
            } else if (Notification.permission !== "denied") {
              Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                  new Notification(title, { body: message });
                }
              });
            }
          }

          // æ’­æ”¾å£°éŸ³
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT"
          );
          audio.play();
        }
      }

      // ç©ºé—²é’Ÿæ§åˆ¶å™¨
      class IdleTimer {
        constructor(element) {
          this.element = element;
          this.timeInput = element.querySelector(".time-input");
          this.startBtn = element.querySelector(".start-btn");
          this.pauseBtn = element.querySelector(".pause-btn");
          this.stopBtn = element.querySelector(".stop-btn");
          this.progressBar = element.querySelector(
            ".linear-progress .progress"
          );

          this.data = dataManager.init();
          this.totalTime = this.data.idleTime;
          this.remainingTime = this.totalTime;
          this.isRunning = false;
          this.interval = null;

          this.init();
        }

        init() {
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.updateProgress();

          // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸‹è¾“å…¥æ¡†å¯ç¼–è¾‘
          this.timeInput.readOnly = false;

          // äº‹ä»¶ç›‘å¬
          this.startBtn.addEventListener("click", () => this.start());
          this.pauseBtn.addEventListener("click", () => this.pause());
          this.stopBtn.addEventListener("click", () => this.stop());

          // å…è®¸ç¼–è¾‘æ—¶é—´
          this.timeInput.addEventListener("blur", () => {
            if (!this.isRunning) {
              const timeParts = this.timeInput.value.split(":");
              if (timeParts.length === 2) {
                const minutes = parseInt(timeParts[0], 10);
                const seconds = parseInt(timeParts[1], 10);

                // éªŒè¯è¾“å…¥
                if (
                  !isNaN(minutes) &&
                  !isNaN(seconds) &&
                  minutes >= 0 &&
                  minutes <= 1440 &&
                  seconds >= 0 &&
                  seconds <= 59
                ) {
                  this.totalTime = minutes * 60 + seconds;
                  this.remainingTime = this.totalTime;
                  this.data.idleTime = this.totalTime;
                  dataManager.save(this.data);
                  this.updateProgress();
                } else {
                  // è¾“å…¥æ— æ•ˆï¼Œé‡ç½®ä¸ºä¹‹å‰çš„æœ‰æ•ˆå€¼
                  this.timeInput.value = dataManager.formatCountdown(
                    this.remainingTime
                  );
                }
              } else {
                // æ ¼å¼æ— æ•ˆï¼Œé‡ç½®ä¸ºä¹‹å‰çš„æœ‰æ•ˆå€¼
                this.timeInput.value = dataManager.formatCountdown(
                  this.remainingTime
                );
              }
            }
          });

          // é™åˆ¶è¾“å…¥æ ¼å¼
          this.timeInput.addEventListener("input", (e) => {
            let value = e.target.value;
            // åªå…è®¸æ•°å­—å’Œå†’å·
            value = value.replace(/[^0-9:]/g, "");

            // å¤„ç†å†’å·ä½ç½®
            const colonIndex = value.indexOf(":");

            if (colonIndex === -1) {
              // æ²¡æœ‰å†’å·ï¼Œè‡ªåŠ¨åœ¨å€’æ•°ç¬¬äºŒä½å‰æ·»åŠ å†’å·
              if (value.length >= 3) {
                value = value.slice(0, -2) + ":" + value.slice(-2);
              }
            } else {
              // æœ‰å†’å·ï¼Œç¡®ä¿å†’å·ååªæœ‰ä¸¤ä½æ•°å­—
              const parts = value.split(":");
              if (parts.length === 2) {
                const minutes = parts[0];
                let seconds = parts[1];

                // é™åˆ¶ç§’æ•°ä¸ºä¸¤ä½
                if (seconds.length > 2) {
                  seconds = seconds.slice(0, 2);
                }

                value = minutes + ":" + seconds;
              }
            }

            // é™åˆ¶æ€»é•¿åº¦ï¼ˆåˆ†é’Ÿæœ€å¤š4ä½ + å†’å· + ç§’æ•°2ä½ = 7ä½ï¼‰
            if (value.length > 7) {
              value = value.slice(0, 7);
            }

            e.target.value = value;
          });
        }

        start() {
          if (!this.isRunning) {
            this.isRunning = true;
            this.timeInput.readOnly = true;
            this.startBtn.style.display = "none";
            this.pauseBtn.style.display = "inline-block";
            this.stopBtn.style.display = "inline-block";

            this.interval = setInterval(() => {
              this.remainingTime--;
              this.timeInput.value = dataManager.formatCountdown(
                this.remainingTime
              );
              this.updateProgress();

              if (this.remainingTime <= 0) {
                this.complete();
              }
            }, 1000);
          }
        }

        pause() {
          if (this.isRunning) {
            this.isRunning = false;
            clearInterval(this.interval);
            this.startBtn.style.display = "inline-block";
            this.pauseBtn.style.display = "none";
          }
        }

        stop() {
          this.isRunning = false;
          clearInterval(this.interval);

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";
        }

        complete() {
          this.isRunning = false;
          clearInterval(this.interval);

          // é‡ç½®è®¡æ—¶å™¨
          this.remainingTime = this.totalTime;
          this.timeInput.value = dataManager.formatCountdown(
            this.remainingTime
          );
          this.timeInput.readOnly = false;
          this.updateProgress();

          this.startBtn.style.display = "inline-block";
          this.pauseBtn.style.display = "none";
          this.stopBtn.style.display = "none";

          // å‘é€é€šçŸ¥
          this.sendNotification("ç©ºé—²æ—¶é—´ç»“æŸ", "ä¼‘æ¯æ—¶é—´ç»“æŸäº†ï¼");
        }

        updateProgress() {
          const progress =
            (this.totalTime - this.remainingTime) / this.totalTime;
          this.progressBar.style.width = `${progress * 100}%`;
        }

        sendNotification(title, message) {
          if ("Notification" in window) {
            if (Notification.permission === "granted") {
              new Notification(title, { body: message });
            } else if (Notification.permission !== "denied") {
              Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                  new Notification(title, { body: message });
                }
              });
            }
          }

          // æ’­æ”¾å£°éŸ³
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT"
          );
          audio.play();
        }
      }

      // åˆå§‹åŒ–åº”ç”¨
      const data = dataManager.init();
      const studyTimeDisplay = document.querySelector(".study-time-display");
      studyTimeDisplay.textContent = dataManager.formatTime(
        data.totalStudyTime
      );

      // åˆå§‹åŒ–ç•ªèŒ„é’Ÿ
      const pomodoroElement = document.querySelector(".pomodoro");
      const pomodoroTimer = new PomodoroTimer(pomodoroElement);

      // åˆå§‹åŒ–ç©ºé—²é’Ÿ
      const idleElement = document.querySelector(".idle");
      const idleTimer = new IdleTimer(idleElement);

      // è¯·æ±‚é€šçŸ¥æƒé™
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }

      // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
      let lastVisibleTime = Date.now();

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œè®¡ç®—ç»è¿‡çš„æ—¶é—´å¹¶æ›´æ–°è®¡æ—¶å™¨
          const now = Date.now();
          const elapsedSeconds = Math.floor((now - lastVisibleTime) / 1000);

          if (pomodoroTimer.isRunning) {
            pomodoroTimer.remainingTime = Math.max(
              0,
              pomodoroTimer.remainingTime - elapsedSeconds
            );
            pomodoroTimer.timeInput.value = dataManager.formatCountdown(
              pomodoroTimer.remainingTime
            );
            pomodoroTimer.updateProgress();

            if (pomodoroTimer.remainingTime <= 0) {
              pomodoroTimer.complete();
            }
          }

          if (idleTimer.isRunning) {
            idleTimer.remainingTime = Math.max(
              0,
              idleTimer.remainingTime - elapsedSeconds
            );
            idleTimer.timeInput.value = dataManager.formatCountdown(
              idleTimer.remainingTime
            );
            idleTimer.updateProgress();

            if (idleTimer.remainingTime <= 0) {
              idleTimer.complete();
            }
          }
        }

        lastVisibleTime = Date.now();
      });

      // é¡µé¢å…³é—­å‰æé†’
      window.addEventListener("beforeunload", (e) => {
        if (pomodoroTimer.isRunning || idleTimer.isRunning) {
          e.preventDefault();
          e.returnValue = "æ‚¨æœ‰æ­£åœ¨è¿è¡Œçš„è®¡æ—¶å™¨ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ";
          return e.returnValue;
        }
      });
    </script>
  </body>
</html>
